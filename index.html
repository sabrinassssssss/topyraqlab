<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мониторинг растений</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f4f4; font-family: Arial, sans-serif; }
        .navbar { background: #2c6e49; padding: 15px; }
        .navbar-brand, .nav-link { color: white !important; font-weight: bold; }
        .section { padding: 50px 20px; text-align: center; }
        video { width: 100%; max-width: 400px; border-radius: 10px; }
        .calendar-table { width: 90%; margin: auto; background: white; border-collapse: collapse; }
        .calendar-table td { padding: 15px; text-align: center; cursor: pointer; border-radius: 50%; }
        .calendar-table .marked { background: #ff758c; color: white; font-weight: bold; }
        .sensor-box { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .btn-custom { background: #2c6e49; color: white; }
    </style>
</head>
<body>

    <!-- Навигация -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="#">Plant Monitor</a>
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="#camera">Камера</a></li>
                <li class="nav-item"><a class="nav-link" href="#analysis">Анализ</a></li>
                <li class="nav-item"><a class="nav-link" href="#calendar">Календарь</a></li>
            </ul>
        </div>
    </nav>

    <!-- Камера -->
    <section id="camera" class="section">
        <h2>Камера</h2>
        <video id="camera-feed" autoplay></video>
        <button class="btn btn-success mt-3" onclick="captureImage()">Сделать фото</button>
        <canvas id="snapshot" style="display:none;"></canvas>
    </section>

    <!-- Датчик и анализ -->
    <section id="analysis" class="section">
        <h2>Данные датчика</h2>
        <div class="sensor-box">
            <p><strong>Влажность почвы:</strong> <span id="sensorData">Нет данных</span>%</p>
            <button class="btn btn-custom" onclick="connectToDevice()">Подключить датчик</button>
        </div>
        <h2 class="mt-4">Рекомендации</h2>
        <p id="advice">Здесь появятся советы...</p>
    </section>

    <!-- Календарь полива -->
    <section id="calendar" class="section">
        <h2>Календарь полива</h2>
        <table class="calendar-table">
            <tbody id="calendar-body"></tbody>
        </table>
        <button class="btn btn-primary mt-3" onclick="addWateringRecord()">Отметить полив</button>
    </section>

    <script>
        // Включение камеры
        <button class="btn btn-secondary mt-2" onclick="switchCamera()">Переключить камеру</button>
let useFrontCamera = false; // По умолчанию основная камера

function startCamera() {
    let constraints = {
        video: { 
            facingMode: useFrontCamera ? "user" : "environment" 
        }
    };

    navigator.mediaDevices.getUserMedia(constraints).then(stream => {
        let videoElement = document.getElementById('camera-feed');
        videoElement.srcObject = stream;
    }).catch(error => {
        alert('Ошибка доступа к камере! Проверьте настройки браузера.');
    });
}

// Переключение между фронтальной и основной камерой
function switchCamera() {
    useFrontCamera = !useFrontCamera;
    startCamera();
}

// Запуск камеры при загрузке страницы
window.onload = startCamera;
        navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
            document.getElementById('camera-feed').srcObject = stream;
        }).catch(error => {
            alert('Ошибка доступа к камере! Проверьте настройки браузера.');
        });

        // Фото с камеры
        function captureImage() {
            let video = document.getElementById('camera-feed');
            let canvas = document.getElementById('snapshot');
            let context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            alert("Фото сделано!");
        }

        // Календарь (создание)
        function generateCalendar() {
            let calendarBody = document.getElementById("calendar-body");
            calendarBody.innerHTML = "";
            let today = new Date();
            let daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();

            let row = document.createElement("tr");
            for (let i = 1; i <= daysInMonth; i++) {
                let cell = document.createElement("td");
                cell.innerText = i;
                cell.onclick = () => markDay(i);
                if (localStorage.getItem(`watering-${i}`)) {
                    cell.classList.add("marked");
                }
                row.appendChild(cell);
                if (i % 7 === 0 || i === daysInMonth) {
                    calendarBody.appendChild(row);
                    row = document.createElement("tr");
                }
            }
        }

        // Отметка полива
        function addWateringRecord() {
            let today = new Date().getDate();
            localStorage.setItem(`watering-${today}`, "done");
            generateCalendar();
        }

        // Пометка дня полива
        function markDay(day) {
            if (localStorage.getItem(`watering-${day}`)) {
                localStorage.removeItem(`watering-${day}`);
            } else {
                localStorage.setItem(`watering-${day}`, "done");
            }
            generateCalendar();
        }

        // Подключение к датчику (через Bluetooth)
        async function connectToDevice() {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ["battery_service"]
                });

                const server = await device.gatt.connect();
                const service = await server.getPrimaryService("battery_service");
                const characteristic = await service.getCharacteristic("battery_level");

                characteristic.addEventListener("characteristicvaluechanged", (event) => {
                    const value = event.target.value.getUint8(0);
                    document.getElementById("sensorData").innerText = value;
                    generateAdvice(value);
                });

                await characteristic.startNotifications();
            } catch (error) {
                console.error("Ошибка подключения:", error);
            }
        }

        // Генерация рекомендаций
        function generateAdvice(humidity) {
            let advice = document.getElementById("advice");
            if (humidity > 70) {
                advice.innerText = "Почва слишком влажная, полив не нужен.";
            } else if (humidity < 30) {
                advice.innerText = "Почва сухая, требуется полив!";
            } else {
                advice.innerText = "Оптимальная влажность. Полив пока не требуется.";
            }
        }

        // Генерация календаря при загрузке
        window.onload = generateCalendar;
    </script>

</body>
</html>
